<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>M3U Elite Studio | Ultimate</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --bg: #0f172a; --sidebar: #1e293b; --card: #334155; 
  --accent: #6366f1; --accent-hover: #4f46e5;
  --text-main: #f8fafc; --text-muted: #94a3b8;
  --border: #475569; --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
}

* { box-sizing: border-box; font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; transition: all 0.2s ease-in-out; }
body { margin: 0; background: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

/* --- Loader --- */
.loader-container {
    position: fixed; top: 0; left: 0; width: 100%; height: 4px;
    background: rgba(0,0,0,0.1); z-index: 9999; display: none;
}
.loader-bar {
    width: 30%; height: 100%; background: linear-gradient(90deg, transparent, var(--accent), transparent);
    animation: loadingMove 1s infinite linear;
}
@keyframes loadingMove { 0% { margin-left: -30%; } 100% { margin-left: 100%; } }

/* --- Scrollbar --- */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent); }

/* --- Sidebar --- */
.sidebar {
    width: 260px; background: var(--sidebar); border-right: 1px solid var(--border);
    display: flex; flex-direction: column; padding: 20px; z-index: 50;
    transition: transform 0.3s ease;
}
.brand { 
    font-size: 20px; font-weight: 800; margin-bottom: 30px; display: flex; align-items: center; gap: 10px;
    background: linear-gradient(to right, var(--accent), #a855f7); -webkit-background-clip: text; color: transparent;
}
.nav-item {
    padding: 12px 15px; border-radius: 12px; cursor: pointer; color: var(--text-muted);
    font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 12px; margin-bottom: 5px;
}
.nav-item:hover, .nav-item.active { background: rgba(99, 102, 241, 0.1); color: var(--accent); }
.nav-item i { width: 20px; text-align: center; }

.storage-info { margin-top: auto; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; font-size: 12px; color: var(--text-muted); }
.storage-bar { height: 4px; background: #333; margin-top: 8px; border-radius: 2px; overflow: hidden; }
.storage-fill { height: 100%; background: var(--accent); width: 0%; transition: 1s; }

/* --- Main Content --- */
.main-content { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative; }

.top-bar {
    height: 70px; border-bottom: 1px solid var(--border); background: var(--bg);
    display: flex; align-items: center; justify-content: space-between; padding: 0 25px;
}
.toggle-sidebar { display: none; background: none; border: none; color: white; font-size: 20px; cursor: pointer; }

.search-container { position: relative; width: 400px; }
.search-input {
    width: 100%; background: var(--sidebar); border: 1px solid var(--border); color: white;
    padding: 10px 15px 10px 40px; border-radius: 10px; font-size: 14px; outline: none;
}
.search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
.search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

.action-btn {
    background: var(--accent); color: white; border: none; padding: 10px 20px;
    border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px;
}
.action-btn:hover { background: var(--accent-hover); transform: translateY(-1px); }
.action-btn.secondary { background: var(--card); border: 1px solid var(--border); color: var(--text-main); }
.action-btn.secondary:hover { border-color: var(--text-muted); }
.action-btn.danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
.action-btn.danger:hover { background: var(--danger); color: white; }

/* --- Workspace --- */
.workspace { flex: 1; padding: 25px; overflow-y: auto; position: relative; }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
.stat-card { background: var(--sidebar); padding: 20px; border-radius: 15px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.stat-info h3 { margin: 0 0 5px 0; font-size: 24px; }
.stat-info p { margin: 0; font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.stat-icon { width: 45px; height: 45px; background: rgba(99, 102, 241, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--accent); font-size: 20px; }

.toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
.filter-select { background: var(--sidebar); border: 1px solid var(--border); color: white; padding: 8px 15px; border-radius: 8px; outline: none; cursor: pointer; }

/* --- List Items --- */
.channel-list { display: flex; flex-direction: column; gap: 8px; }
.channel-item {
    background: var(--sidebar); border: 1px solid var(--border); padding: 10px 15px; border-radius: 10px;
    display: flex; align-items: center; gap: 15px; cursor: pointer; position: relative;
}
.channel-item:hover { border-color: var(--accent); transform: translateX(3px); }
.channel-item.selected { background: rgba(99, 102, 241, 0.1); border-color: var(--accent); }

/* History Specific Style */
.channel-item.history-item { opacity: 0.8; border-style: dashed; }
.channel-item.history-item:hover { opacity: 1; border-style: solid; }
.history-meta { font-size: 10px; color: var(--text-muted); margin-top: 4px; display:flex; align-items:center; gap:5px}

.drag-handle { color: var(--text-muted); cursor: grab; padding: 5px; }
.ch-check { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); }
.ch-logo { width: 40px; height: 40px; background: #000; border-radius: 8px; object-fit: contain; }
.ch-details { flex: 1; min-width: 0; }
.ch-name { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.ch-group { font-size: 11px; color: var(--text-muted); background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; }
.ch-status { width: 10px; height: 10px; border-radius: 50%; background: var(--border); box-shadow: 0 0 5px rgba(0,0,0,0.5); }
.ch-status.live { background: var(--success); box-shadow: 0 0 8px var(--success); }
.ch-status.dead { background: var(--danger); }
.ch-actions { display: flex; gap: 8px; opacity: 0; }
.channel-item:hover .ch-actions { opacity: 1; }

.icon-btn { width: 32px; height: 32px; border-radius: 6px; border: none; background: var(--card); color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; }
.icon-btn:hover { background: var(--accent); color: white; }
.icon-btn.play-btn { color: var(--accent); background: rgba(99, 102, 241, 0.1); }
.icon-btn.play-btn:hover { background: var(--accent); color: white; }
.icon-btn.danger:hover { background: var(--danger); }

/* --- Floating Bulk Action Bar --- */
.bulk-bar {
    position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
    background: var(--accent); padding: 10px 20px; border-radius: 50px;
    display: flex; align-items: center; gap: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 100;
}
.bulk-bar.active { transform: translateX(-50%) translateY(0); }
.bulk-count { font-weight: bold; background: rgba(0,0,0,0.2); padding: 2px 10px; border-radius: 20px; font-size: 12px; }

/* --- Modals --- */
.modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
    display: none; justify-content: center; align-items: center; z-index: 1000; opacity: 0;
}
.modal-overlay.open { display: flex; animation: fadeIn 0.2s forwards; }
@keyframes fadeIn { to { opacity: 1; } }

.modal-box {
    background: var(--sidebar); width: 90%; max-width: 500px; border-radius: 16px;
    border: 1px solid var(--border); padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    transform: scale(0.9); transition: 0.3s;
}
.modal-overlay.open .modal-box { transform: scale(1); }

.form-group { margin-bottom: 15px; }
.form-label { display: block; font-size: 12px; font-weight: bold; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }
.form-input { width: 100%; background: var(--bg); border: 1px solid var(--border); padding: 12px; border-radius: 8px; color: white; outline: none; }
.form-input:focus { border-color: var(--accent); }
.input-with-btn { display: flex; gap: 5px; }
textarea.form-input { min-height: 100px; font-family: monospace; font-size: 12px; }

.clean-option { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg); border-radius: 8px; cursor: pointer; border: 1px solid var(--border); margin-bottom: 8px; }
.clean-option:hover { border-color: var(--accent); }

/* --- Advanced Player --- */
.player-modal-box {
    background: #000; width: 100%; height: 100%; max-width: none; max-height: none; 
    border-radius: 0; padding: 0; display: flex; flex-direction: column; justify-content: center;
}
.player-header {
    position: absolute; top: 0; left: 0; width: 100%; padding: 20px; z-index: 10;
    background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
    display: flex; justify-content: space-between; align-items: center;
}
.player-title { color: #fff; font-size: 16px; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
.player-close { 
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
    color: white; border-radius: 50%; width: 40px; height: 40px; cursor: pointer;
    backdrop-filter: blur(5px);
}
.player-close:hover { background: var(--danger); border-color: var(--danger); }

/* --- Toast --- */
.toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
.toast { 
    background: var(--card); border: 1px solid var(--border); padding: 15px 20px; 
    border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); 
    display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
    color: white; font-size: 14px; backdrop-filter: blur(10px); min-width: 280px;
}
.toast-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0; }
.toast.success .toast-icon { background: rgba(16, 185, 129, 0.2); color: var(--success); }
.toast.danger .toast-icon { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
.toast.warning .toast-icon { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
@keyframes slideIn { from { transform: translateX(100%) scale(0.9); opacity: 0; } to { transform: translateX(0) scale(1); opacity: 1; } }

@media (max-width: 768px) {
    .sidebar { position: fixed; height: 100%; transform: translateX(-100%); width: 80%; }
    .sidebar.active { transform: translateX(0); }
    .toggle-sidebar { display: block; }
    .top-bar { padding: 0 15px; }
    .search-container { display: none; }
    .stat-card { padding: 15px; }
    .ch-actions { display: none; } 
    .bulk-bar { width: 90%; border-radius: 15px; flex-wrap: wrap; justify-content: center; }
}
</style>
</head>
<body>

<div class="loader-container" id="loader"><div class="loader-bar"></div></div>

<nav class="sidebar" id="sidebar">
    <div class="brand">
        <i class="fa-solid fa-layer-group"></i> Elite Studio
    </div>
    <div class="nav-item active" onclick="setView('editor')">
        <i class="fa-solid fa-list-ul"></i> Editor
    </div>
    <div class="nav-item" onclick="setView('import')">
        <i class="fa-solid fa-cloud-arrow-up"></i> Import / Source
    </div>
    <div class="nav-item" onclick="setView('library')">
        <i class="fa-solid fa-book-bookmark"></i> Saved Library
    </div>
    <div class="nav-item" onclick="setView('history')">
        <i class="fa-solid fa-clock-rotate-left"></i> Trash / History
    </div>
    <div class="storage-info">
        <div style="display:flex; justify-content:space-between">
            <span>Storage Used</span>
            <span id="storagePercent">0%</span>
        </div>
        <div class="storage-bar"><div class="storage-fill" id="storageFill"></div></div>
    </div>
</nav>

<main class="main-content">
    <header class="top-bar">
        <div style="display:flex; align-items:center; gap:15px">
            <button class="toggle-sidebar" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
            <h3 style="margin:0; font-size:16px" id="pageTitle">Playlist Editor</h3>
        </div>
        <div class="search-container" id="headerSearch">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" class="search-input" placeholder="Search channels..." oninput="filterList(this.value)">
        </div>
        <div style="display:flex; gap:10px">
            <button class="action-btn secondary" onclick="openExportModal()">
                <i class="fa-solid fa-download"></i> Export
            </button>
            <button class="action-btn" onclick="saveToLibrary()">
                <i class="fa-solid fa-save"></i> Save Lib
            </button>
        </div>
    </header>

    <div class="workspace" id="workspace">
        <div id="view-editor">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-info"><h3 id="statTotal">0</h3><p>Total Channels</p></div>
                    <div class="stat-icon"><i class="fa-solid fa-tv"></i></div>
                </div>
                <div class="stat-card">
                    <div class="stat-info"><h3 id="statGroups">0</h3><p>Groups</p></div>
                    <div class="stat-icon"><i class="fa-solid fa-folder-tree"></i></div>
                </div>
                <div class="stat-card">
                    <div class="stat-info"><h3 id="statSelected">0</h3><p>Selected</p></div>
                    <div class="stat-icon" style="color:var(--warning)"><i class="fa-solid fa-check-double"></i></div>
                </div>
            </div>

            <div class="toolbar">
                <select class="filter-select" id="groupFilter" onchange="applyFilters()">
                    <option value="all">All Groups</option>
                </select>
                <button class="action-btn secondary" onclick="openModal('cleanModal')">
                    <i class="fa-solid fa-broom"></i> Clean Duplicates
                </button>
                <button class="action-btn secondary" onclick="checkAllStreamHealth()">
                    <i class="fa-solid fa-stethoscope"></i> Check Health
                </button>
                <button class="action-btn secondary" onclick="selectAll()">
                    <i class="fa-solid fa-check-square"></i> Select All
                </button>
                <button class="action-btn danger" onclick="clearPlaylist()">
                    <i class="fa-solid fa-trash"></i> Clear All
                </button>
            </div>
            <div class="channel-list" id="channelList"></div>
        </div>

        <div id="view-import" style="display:none; max-width: 600px; margin: 0 auto;">
            <div class="stat-card" style="display:block; margin-bottom: 20px;">
                <h3 style="margin-top:0">Import from URL</h3>
                <div class="form-group"><input type="text" class="form-input" id="importUrl" placeholder="https://example.com/playlist.m3u"></div>
                <button class="action-btn" style="width:100%; justify-content:center" onclick="fetchUrl()">Fetch Playlist</button>
            </div>
            <div class="stat-card" style="display:block; margin-bottom: 20px;">
                <h3 style="margin-top:0">Import Local File</h3>
                <div class="form-group"><input type="file" id="fileInput" accept=".m3u,.m3u8" class="form-input" style="padding: 8px;"></div>
                <button class="action-btn secondary" style="width:100%; justify-content:center" onclick="parseFile()">Load File</button>
            </div>
             <div class="stat-card" style="display:block;">
                <h3 style="margin-top:0">Paste Raw Text</h3>
                <textarea id="rawText" class="form-input" rows="6" placeholder="#EXTM3U..."></textarea>
                <button class="action-btn secondary" style="width:100%; margin-top:10px; justify-content:center" onclick="parseRaw()">Parse Text</button>
            </div>
        </div>

        <div id="view-library" style="display:none">
            <h2 style="margin-top:0">Saved Playlists</h2>
            <div id="libraryList" class="channel-list"></div>
        </div>
        
        <div id="view-history" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:var(--card); padding:15px; border-radius:12px; border:1px solid var(--border)">
                <h2 style="margin:0; font-size:18px;">History / Trash</h2>
                <div style="display:flex; gap:10px">
                    <button class="action-btn secondary" onclick="reinstallAllHistory()">
                        <i class="fa-solid fa-rotate-left"></i> Restore All
                    </button>
                    <button class="action-btn danger" onclick="nukeHistory()">
                        <i class="fa-solid fa-fire"></i> Wipe All
                    </button>
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom:20px">
                <input type="text" class="form-input" id="historySearchInput" placeholder="Search deleted channels..." oninput="renderHistory()">
            </div>

            <div id="historyList" class="channel-list"></div>
        </div>
    </div>

    <div class="bulk-bar" id="bulkBar">
        <span class="bulk-count" id="bulkCount">0 selected</span>
        <button class="icon-btn" style="border-radius:50%" onclick="bulkEditGroup()" title="Move to Group"><i class="fa-solid fa-folder"></i></button>
        <button class="icon-btn danger" style="border-radius:50%" onclick="bulkDelete()" title="Delete Selected"><i class="fa-solid fa-trash"></i></button>
        <button class="icon-btn" style="border-radius:50%" onclick="deselectAll()" title="Cancel"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div class="bulk-bar" id="historyBulkBar" style="background: var(--card); border:1px solid var(--border)">
        <span class="bulk-count" id="historyBulkCount" style="color:white">0 selected</span>
        <button class="icon-btn" style="border-radius:50%; color:var(--success)" onclick="bulkHistoryRestore()" title="Restore Selected"><i class="fa-solid fa-rotate-left"></i></button>
        <button class="icon-btn danger" style="border-radius:50%" onclick="bulkHistoryDelete()" title="Delete Forever"><i class="fa-solid fa-fire"></i></button>
        <button class="icon-btn" style="border-radius:50%" onclick="deselectAllHistory()" title="Cancel"><i class="fa-solid fa-xmark"></i></button>
    </div>
</main>

<div class="modal-overlay" id="editModal">
    <div class="modal-box">
        <h3>Edit Channel</h3>
        <div class="form-group"><label class="form-label">Name</label><input id="editName" class="form-input"></div>
        <div class="form-group"><label class="form-label">Group</label><input id="editGroup" class="form-input" list="groupSuggestions"><datalist id="groupSuggestions"></datalist></div>
        <div class="form-group"><label class="form-label">Logo URL</label><input id="editLogo" class="form-input"></div>
        <div class="form-group">
            <label class="form-label">Stream URL</label>
            <div class="input-with-btn">
                <input id="editUrl" class="form-input">
                <button class="icon-btn" onclick="copyEditUrl()" title="Copy Link"><i class="fa-solid fa-copy"></i></button>
            </div>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end">
            <button class="action-btn secondary" onclick="closeModal('editModal')">Cancel</button>
            <button class="action-btn" onclick="saveEdit()">Save Changes</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="cleanModal">
    <div class="modal-box">
        <h3>Remove Duplicates</h3>
        <p style="color:var(--text-muted); font-size:13px; margin-bottom:15px">Duplicate channels will be moved to History.</p>
        <label class="clean-option">
            <input type="radio" name="cleanType" value="link" checked>
            <span>By Link (URL)</span>
        </label>
        <label class="clean-option">
            <input type="radio" name="cleanType" value="name">
            <span>By Channel Name</span>
        </label>
        <div style="display:flex; gap:10px; margin-top:20px; justify-content:flex-end">
            <button class="action-btn secondary" onclick="closeModal('cleanModal')">Cancel</button>
            <button class="action-btn" onclick="runClean()">Start Cleaning</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="linkModal">
    <div class="modal-box">
        <h3>Stream Link</h3>
        <textarea id="linkDisplay" class="form-input" style="height:100px; margin-bottom:15px" readonly></textarea>
        <div style="display:flex; gap:10px; justify-content:flex-end">
            <button class="action-btn secondary" onclick="closeModal('linkModal')">Close</button>
            <button class="action-btn" onclick="copyFromLinkModal()">Copy Link</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="playerModal">
    <div class="modal-box player-modal-box">
        <div class="player-header">
            <div class="player-title" id="playerTitle">Live Stream</div>
            <button class="player-close" onclick="closePlayer()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div style="position:relative; width:100%; height:100%; background:black;">
            <video id="videoPlayer" style="width:100%; height:100%" controls autoplay></video>
        </div>
    </div>
</div>

<div class="modal-overlay" id="exportModal">
    <div class="modal-box">
        <h3>Export Playlist</h3>
        <div class="form-group">
            <label class="form-label">Filename</label>
            <input id="exportName" class="form-input" value="playlist_elite">
        </div>
        <div class="form-group">
            <label class="form-label">Select Group to Export</label>
            <select id="exportGroupSelect" class="form-input" style="cursor:pointer">
                <option value="all">All Channels (Full Export)</option>
            </select>
        </div>
        <div style="display:flex; gap:10px; flex-direction:column">
            <button class="action-btn" onclick="downloadM3U()">Download .M3U File</button>
            <button class="action-btn secondary" onclick="copyM3U()">Copy to Clipboard</button>
            <button class="action-btn secondary" style="border:none" onclick="closeModal('exportModal')">Close</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="bulkGroupModal">
    <div class="modal-box">
        <h3>Move Selected to Group</h3>
        <div class="form-group"><label class="form-label">New Group Name</label><input id="bulkGroupName" class="form-input"></div>
        <div style="display:flex; gap:10px; justify-content:flex-end">
            <button class="action-btn secondary" onclick="closeModal('bulkGroupModal')">Cancel</button>
            <button class="action-btn" onclick="applyBulkGroup()">Move</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toastArea"></div>

<script>
/* --- State --- */
let channels = [], deleted = [], library = [], selected = new Set(), historySelected = new Set(), editId = null, player = null;

/* --- Init --- */
window.onload = () => {
    loadData();
    initPlayer();
    initSortable();
    renderStats();
};

function initPlayer() {
    shaka.polyfill.installAll();
    if (shaka.Player.isBrowserSupported()) {
        const video = document.getElementById('videoPlayer');
        player = new shaka.Player(video);
        player.addEventListener('error', onErrorEvent);
    }
}
function onErrorEvent(event) { console.error('Error code', event.detail.code, 'object', event.detail); }

function initSortable() {
    new Sortable(document.getElementById('channelList'), {
        handle: '.drag-handle', animation: 150, ghostClass: 'selected',
        onEnd: (evt) => {
            const item = channels.splice(evt.oldIndex, 1)[0];
            channels.splice(evt.newIndex, 0, item);
            saveData();
        }
    });
}

function showLoader(show) { document.getElementById('loader').style.display = show ? 'block' : 'none'; }

/* --- Core Logic --- */
function parseLine(line, metadata) {
    if(!metadata) return null;
    const parts = metadata.split(',');
    const name = parts[parts.length - 1];
    const logo = (metadata.match(/tvg-logo="([^"]*)"/i) || [])[1] || "";
    const group = (metadata.match(/group-title="([^"]*)"/i) || [])[1] || "Ungrouped";
    return { name, logo, group, url: line.trim(), id: Date.now() + Math.random(), status: 'unknown' };
}

function processM3U(text) {
    const lines = text.split(/\r?\n/);
    let meta = null;
    let newCh = [];
    lines.forEach(l => {
        l = l.trim();
        if(l.startsWith('#EXTINF')) meta = l;
        else if(l && !l.startsWith('#') && meta) {
            newCh.push(parseLine(l, meta));
            meta = null;
        }
    });
    return newCh;
}

// Fetch Logic
async function fetchUrl() {
    const url = document.getElementById('importUrl').value;
    if(!url) return showToast('Enter URL', 'danger');
    
    showLoader(true);
    let newItems = [];
    let fetchSuccess = false;

    try {
        const res = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
        if(!res.ok) throw new Error(`HTTP Error ${res.status}`);
        const txt = await res.text();
        newItems = processM3U(txt);
        if(newItems.length === 0) throw new Error("No channels found");
        fetchSuccess = true;
    } catch(e) {
        showToast('Fetch Failed: ' + e.message, 'danger');
        console.error(e);
    }

    if(fetchSuccess) {
        channels = [...channels, ...newItems];
        saveData(); setView('editor'); renderList();
        showToast(`Imported ${newItems.length} channels`, 'success');
    }
    showLoader(false);
}

function parseRaw() {
    const txt = document.getElementById('rawText').value;
    if(!txt) return;
    showLoader(true);
    setTimeout(() => {
        const newItems = processM3U(txt);
        channels = [...channels, ...newItems];
        saveData(); setView('editor'); renderList();
        showToast(`Parsed ${newItems.length} channels`, 'success');
        showLoader(false);
    }, 100);
}

function parseFile() {
    const file = document.getElementById('fileInput').files[0];
    if(!file) return;
    showLoader(true);
    const reader = new FileReader();
    reader.onload = (e) => {
        const newItems = processM3U(e.target.result);
        channels = [...channels, ...newItems];
        saveData(); setView('editor'); renderList();
        showToast(`Loaded ${newItems.length} channels`, 'success');
        showLoader(false);
    };
    reader.readAsText(file);
}

/* --- Rendering --- */
function renderList() {
    const list = document.getElementById('channelList');
    list.innerHTML = '';
    const filter = document.getElementById('groupFilter').value;
    const search = document.querySelector('.search-input').value.toLowerCase();
    
    // Group logic
    const datalist = document.getElementById('groupSuggestions');
    datalist.innerHTML = '';
    const uniqueGroups = [...new Set(channels.map(c => c.group))];
    uniqueGroups.sort().forEach(g => datalist.innerHTML += `<option value="${g}">`);
    
    const sel = document.getElementById('groupFilter');
    if(sel.options.length <= 1 || uniqueGroups.length > sel.options.length) {
        sel.innerHTML = '<option value="all">All Groups</option>';
        uniqueGroups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g; opt.innerText = g;
            if(g === filter) opt.selected = true;
            sel.appendChild(opt);
        });
    }

    channels.forEach((c, index) => {
        if(filter !== 'all' && c.group !== filter) return;
        if(search && !c.name.toLowerCase().includes(search) && !c.group.toLowerCase().includes(search)) return;

        const el = document.createElement('div');
        el.className = `channel-item ${selected.has(index) ? 'selected' : ''}`;
        el.innerHTML = `
            <i class="fa-solid fa-grip-vertical drag-handle"></i>
            <input type="checkbox" class="ch-check" ${selected.has(index) ? 'checked' : ''} onchange="toggleSelect(${index})">
            <img src="${c.logo}" class="ch-logo" onerror="this.src='https://placehold.co/40?text=TV'">
            <div class="ch-details" onclick="openEdit(${index})">
                <div class="ch-name">${c.name}</div>
                <div class="ch-group">${c.group}</div>
            </div>
            <div class="ch-status ${c.status === 'live' ? 'live' : (c.status === 'dead' ? 'dead' : '')}" title="${c.status}"></div>
            <div class="ch-actions">
                <button class="icon-btn" onclick="viewLink('${c.url.replace(/'/g, "\\'")}')" title="View Link"><i class="fa-solid fa-link"></i></button>
                <button class="icon-btn play-btn" onclick="playChannel(${index})"><i class="fa-solid fa-play"></i></button>
                <button class="icon-btn" onclick="openEdit(${index})"><i class="fa-solid fa-pen"></i></button>
                <button class="icon-btn danger" onclick="deleteChannel(${index})"><i class="fa-solid fa-trash"></i></button>
            </div>
        `;
        list.appendChild(el);
    });
    renderStats();
}

function renderStats() {
    document.getElementById('statTotal').innerText = channels.length;
    document.getElementById('statGroups').innerText = new Set(channels.map(c=>c.group)).size;
    document.getElementById('statSelected').innerText = selected.size;
    
    const size = new Blob([JSON.stringify(channels)]).size;
    const percent = Math.min((size / (5 * 1024 * 1024)) * 100, 100).toFixed(1);
    document.getElementById('storageFill').style.width = percent + '%';
    document.getElementById('storagePercent').innerText = percent + '%';
}

/* --- Clean Duplicates --- */
function runClean() {
    const type = document.querySelector('input[name="cleanType"]:checked').value;
    const initial = channels.length;
    const seen = new Set();
    const newCh = [];
    
    channels.forEach(c => {
        const key = type === 'link' ? c.url.trim() : c.name.toLowerCase().trim();
        if(seen.has(key)) {
            // Add timestamp before moving to deleted
            c.deletedAt = Date.now();
            deleted.unshift(c);
        } else { 
            seen.add(key); newCh.push(c); 
        }
    });

    channels = newCh;
    saveData(); renderList(); renderHistory(); closeModal('cleanModal');
    showToast(`Removed ${initial - channels.length} duplicates`, 'success');
}

/* --- Link Viewer --- */
function viewLink(url) {
    document.getElementById('linkDisplay').value = url;
    openModal('linkModal');
}
function copyFromLinkModal() {
    const input = document.getElementById('linkDisplay');
    input.select(); document.execCommand('copy');
    showToast('Link Copied', 'success');
}

/* --- Actions --- */
function toggleSelect(index) {
    if(selected.has(index)) selected.delete(index);
    else selected.add(index);
    const bar = document.getElementById('bulkBar');
    if(selected.size > 0) bar.classList.add('active');
    else bar.classList.remove('active');
    document.getElementById('bulkCount').innerText = `${selected.size} selected`;
    renderStats();
}

function selectAll() {
    channels.forEach((_, i) => selected.add(i));
    renderList(); toggleSelect(-1);
}

function deselectAll() {
    selected.clear(); renderList();
    document.getElementById('bulkBar').classList.remove('active');
}

function bulkDelete() {
    if(!confirm(`Delete ${selected.size} channels?`)) return;
    const newCh = [];
    channels.forEach((c, i) => {
        if(selected.has(i)) {
            c.deletedAt = Date.now();
            deleted.unshift(c);
        } else newCh.push(c);
    });
    channels = newCh; selected.clear();
    saveData(); renderList(); renderHistory();
    document.getElementById('bulkBar').classList.remove('active');
    showToast('Batch delete successful', 'success');
}

function bulkEditGroup() { openModal('bulkGroupModal'); }
function applyBulkGroup() {
    const newG = document.getElementById('bulkGroupName').value;
    if(!newG) return;
    channels.forEach((c, i) => { if(selected.has(i)) c.group = newG; });
    closeModal('bulkGroupModal'); deselectAll(); saveData(); renderList();
    showToast('Groups Updated', 'success');
}

async function checkAllStreamHealth() {
    showToast('Checking stream health...', 'warning');
    const toCheck = channels.slice(0, 50); 
    for (let c of toCheck) {
        try {
            const controller = new AbortController();
            setTimeout(() => controller.abort(), 2000);
            const res = await fetch(c.url, { method: 'HEAD', signal: controller.signal });
            c.status = res.ok ? 'live' : 'dead';
        } catch { c.status = 'dead'; }
    }
    renderList(); showToast('Check complete (First 50)', 'success');
}

/* --- Editor Modal --- */
function openEdit(index) {
    editId = index;
    const c = channels[index];
    document.getElementById('editName').value = c.name;
    document.getElementById('editGroup').value = c.group;
    document.getElementById('editLogo').value = c.logo;
    document.getElementById('editUrl').value = c.url;
    openModal('editModal');
}

function copyEditUrl() {
    const url = document.getElementById('editUrl').value;
    navigator.clipboard.writeText(url);
    showToast('URL copied', 'success');
}

function saveEdit() {
    if(editId === null) return;
    channels[editId] = {
        ...channels[editId],
        name: document.getElementById('editName').value,
        group: document.getElementById('editGroup').value,
        logo: document.getElementById('editLogo').value,
        url: document.getElementById('editUrl').value
    };
    saveData(); renderList(); closeModal('editModal');
    showToast('Changes saved', 'success');
}

/* --- Advanced Player Logic --- */
function playChannel(index) {
    if(index === undefined || !channels[index]) return;
    const c = channels[index];
    const url = c.url;
    const name = c.name;

    openModal('playerModal');
    document.getElementById('playerTitle').innerText = name || "Live Stream";
    
    player.load(url).then(function() {
        console.log('Video loaded');
    }).catch(function(e) {
        console.error('Error code', e.code, 'object', e);
        showToast('Stream Error: ' + e.code, 'danger');
    });
}
function closePlayer() {
    player.unload();
    closeModal('playerModal');
}

/* --- Export --- */
function openExportModal() {
    const sel = document.getElementById('exportGroupSelect');
    sel.innerHTML = '<option value="all">All Channels (Full Export)</option>';
    const uniqueGroups = [...new Set(channels.map(c => c.group))];
    uniqueGroups.sort().forEach(g => {
        sel.innerHTML += `<option value="${g}">${g}</option>`;
    });
    openModal('exportModal');
}

function generateM3U() {
    const filter = document.getElementById('exportGroupSelect').value;
    let out = "#EXTM3U\n";
    channels.forEach(c => {
        if (filter !== 'all' && c.group !== filter) return;
        out += `#EXTINF:-1 tvg-logo="${c.logo}" group-title="${c.group}",${c.name}\n${c.url}\n`;
    });
    return out;
}
function copyM3U() { navigator.clipboard.writeText(generateM3U()); showToast('Copied to Clipboard', 'success'); }
function downloadM3U() {
    const blob = new Blob([generateM3U()], {type: 'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (document.getElementById('exportName').value || 'playlist') + '.m3u';
    a.click();
}

/* --- System --- */
function saveData() {
    localStorage.setItem('elite_channels', JSON.stringify(channels));
    localStorage.setItem('elite_deleted', JSON.stringify(deleted));
    localStorage.setItem('elite_library', JSON.stringify(library));
    renderStats();
}
function loadData() {
    const c = localStorage.getItem('elite_channels');
    const d = localStorage.getItem('elite_deleted');
    const l = localStorage.getItem('elite_library');
    if(c) channels = JSON.parse(c);
    if(d) deleted = JSON.parse(d);
    if(l) library = JSON.parse(l);
    renderList(); renderHistory(); renderLibrary();
}

function setView(view) {
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    // Find nav item with correct onclick
    const navItems = document.querySelectorAll('.nav-item');
    for(let item of navItems) {
        if(item.getAttribute('onclick').includes(view)) item.classList.add('active');
    }
    
    ['editor','import','library','history'].forEach(v => document.getElementById('view-'+v).style.display = 'none');
    document.getElementById('view-' + view).style.display = 'block';
    document.getElementById('headerSearch').style.visibility = view === 'editor' ? 'visible' : 'hidden';
    document.getElementById('pageTitle').innerText = view.charAt(0).toUpperCase() + view.slice(1);
    if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('active');
}

/* --- Advanced History System --- */
function renderHistory() {
    const list = document.getElementById('historyList');
    const searchVal = document.getElementById('historySearchInput').value.toLowerCase();
    list.innerHTML = deleted.length ? '' : '<div style="text-align:center; color:gray; padding:20px">Trash is empty</div>';
    
    deleted.forEach((c, i) => {
        if(searchVal && !c.name.toLowerCase().includes(searchVal)) return;

        const d = document.createElement('div');
        d.className = `channel-item history-item ${historySelected.has(i) ? 'selected' : ''}`;
        
        // Format Date
        const dateStr = c.deletedAt ? new Date(c.deletedAt).toLocaleString() : 'Unknown Date';

        d.innerHTML = `
            <input type="checkbox" class="ch-check" ${historySelected.has(i) ? 'checked' : ''} onchange="toggleHistorySelect(${i})">
            <img src="${c.logo}" class="ch-logo" onerror="this.src='https://placehold.co/40?text=TV'">
            <div class="ch-details">
                <div class="ch-name">${c.name}</div>
                <div class="history-meta"><i class="fa-regular fa-clock"></i> Deleted: ${dateStr}</div>
                <div class="ch-group" style="cursor:pointer; color:var(--accent)" onclick="viewLink('${c.url.replace(/'/g, "\\'")}')">View Link</div>
            </div>
            <button class="action-btn" onclick="restore(${i})">Restore</button>
        `;
        list.appendChild(d);
    });
    
    // Manage floating bar for history
    const hBar = document.getElementById('historyBulkBar');
    if(historySelected.size > 0) {
        hBar.classList.add('active');
        document.getElementById('historyBulkCount').innerText = `${historySelected.size} selected`;
    } else {
        hBar.classList.remove('active');
    }
}

function toggleHistorySelect(index) {
    if(historySelected.has(index)) historySelected.delete(index);
    else historySelected.add(index);
    renderHistory();
}

function deselectAllHistory() {
    historySelected.clear();
    renderHistory();
}

function bulkHistoryRestore() {
    if(!confirm(`Restore ${historySelected.size} items?`)) return;
    let remaining = [];
    deleted.forEach((c, i) => {
        if(historySelected.has(i)) channels.push(c);
        else remaining.push(c);
    });
    deleted = remaining;
    historySelected.clear();
    saveData(); renderList(); renderHistory();
    showToast('Items restored successfully', 'success');
}

function bulkHistoryDelete() {
    if(!confirm(`Permanently delete ${historySelected.size} items? This cannot be undone.`)) return;
    let remaining = [];
    deleted.forEach((c, i) => {
        if(!historySelected.has(i)) remaining.push(c);
    });
    deleted = remaining;
    historySelected.clear();
    saveData(); renderHistory();
    showToast('Items deleted forever', 'danger');
}

function restore(i) { 
    channels.push(deleted[i]); 
    deleted.splice(i, 1); 
    saveData(); renderList(); renderHistory(); 
    showToast('Channel restored', 'success'); 
}

function reinstallAllHistory() { 
    if(confirm("Restore all items from history?")) {
        channels = [...channels, ...deleted]; deleted = []; 
        saveData(); renderList(); renderHistory(); showToast('All restored', 'success');
    }
}
function nukeHistory() {
    if(confirm("Permanently delete ALL history?")) { deleted = []; saveData(); renderHistory(); showToast('History Wiped', 'danger'); }
}

/* --- Library --- */
function saveToLibrary() {
    const name = prompt("Playlist Name:");
    if(name) { library.push({name, count: channels.length, data: [...channels]}); saveData(); renderLibrary(); showToast('Saved to Library', 'success'); }
}
function renderLibrary() {
    const list = document.getElementById('libraryList');
    list.innerHTML = '';
    library.forEach((l, i) => {
        const d = document.createElement('div');
        d.className = 'channel-item';
        d.innerHTML = `
            <div class="ch-details"><div class="ch-name">${l.name}</div><div class="ch-group">${l.count} Channels</div></div>
            <button class="action-btn" onclick="loadLib(${i})">Load</button>
            <button class="icon-btn danger" onclick="delLib(${i})"><i class="fa-solid fa-trash"></i></button>
        `;
        list.appendChild(d);
    });
}
function loadLib(i) {
    if(confirm("Overwrite current workspace?")) { channels = [...library[i].data]; saveData(); renderList(); setView('editor'); }
}
function delLib(i) { library.splice(i, 1); saveData(); renderLibrary(); }

/* --- UI Helpers --- */
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

function showToast(msg, type='success') {
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    let icon = 'fa-check';
    if(type === 'danger') icon = 'fa-circle-exclamation';
    if(type === 'warning') icon = 'fa-triangle-exclamation';
    el.innerHTML = `<div class="toast-icon"><i class="fa-solid ${icon}"></i></div><span>${msg}</span>`;
    document.getElementById('toastArea').appendChild(el);
    setTimeout(() => {
        el.style.opacity = '0';
        el.style.transform = 'translateX(100%)';
        setTimeout(() => el.remove(), 300);
    }, 3000);
}

function filterList(val) { renderList(); }
function applyFilters() { renderList(); }
function deleteChannel(i) { 
    let c = channels[i];
    c.deletedAt = Date.now(); // Add timestamp
    deleted.unshift(c); 
    channels.splice(i, 1); 
    saveData(); renderList(); renderHistory(); 
}
function clearPlaylist() { if(confirm('Nuke everything?')) { channels=[]; saveData(); renderList(); } }
</script>
</body>
</html>
